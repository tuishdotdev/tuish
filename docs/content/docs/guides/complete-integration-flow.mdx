---
title: Complete Integration Flow
description: End-to-end guide from developer signup to first customer purchase
---

# Complete Integration Flow

This guide walks through the entire Tuish integration, from creating your developer account to processing your first customer payment.

## Architecture Overview

Tuish uses a **passthrough payment model** (like Gumroad, not a marketplace):

- You connect **your own Stripe account** via OAuth
- Payments go **directly to you**
- Platform takes a small application fee via Stripe Connect
- Licenses are cryptographically signed and work offline

```
Developer                    Tuish                      Customer
    │                          │                            │
    │  1. signup + connect     │                            │
    │─────────────────────────▶│                            │
    │                          │                            │
    │  2. create product       │                            │
    │─────────────────────────▶│                            │
    │                          │                            │
    │  3. integrate SDK        │                            │
    │◀─────────────────────────│                            │
    │                          │                            │
    │                          │  4. purchase via SDK       │
    │                          │◀───────────────────────────│
    │                          │                            │
    │  5. payment to Stripe    │  6. license issued         │
    │◀─────────────────────────│───────────────────────────▶│
    │                          │                            │
```

---

## Part 1: Developer Setup

### Step 1: Create Your Developer Account

```bash
# Install the CLI globally
npm install -g tuish

# Sign up - returns your API key
tuish signup --email you@example.com --name "Your Name"
```

Response:
```
✓ Account created successfully!

Your API key: tuish_sk_27ce24d3db0a48987ea9b99f6e768356...

Save this key securely - it won't be shown again.
Run 'tuish login -k <key>' to authenticate this device.
```

### Step 2: Connect Your Stripe Account

Before you can create products, you must connect Stripe:

```bash
tuish connect
```

This opens your browser for Stripe OAuth. After authorizing, your account is linked.

Verify connection:
```bash
tuish connect --status
```

### Step 3: Create a Product

```bash
tuish products create \
  --name "My Awesome CLI" \
  --slug "my-cli" \
  --price 29.99 \
  --billing one_time
```

Response:
```
✓ Product created!

Product ID: prod_abc123...
Name: My Awesome CLI
Price: $29.99 (one-time)

Add this to your SDK configuration:
  productId: 'prod_abc123...'
```

---

## Part 2: SDK Integration

### Install the SDK

```bash
npm install @tuish/sdk
```

### Basic Integration

```typescript
import { Tuish } from '@tuish/sdk';

// Initialize with your product credentials
const tuish = new Tuish({
  productId: 'prod_abc123...',   // From product creation
  publicKey: 'pk_...',           // Your Ed25519 public key
  apiKey: 'tuish_sk_...',        // Optional: for first-time purchases
});

async function main() {
  // Check for existing license
  const result = await tuish.checkLicense();

  if (result.valid) {
    console.log('License valid until:', result.license.expiresAt);
    runMyApp();
  } else {
    console.log('No valid license found.');
    await promptForPurchase();
  }
}

async function promptForPurchase() {
  // Option 1: Browser checkout (recommended for first-time)
  await tuish.purchaseInBrowser();

  // Option 2: Terminal purchase (for returning customers)
  // await tuish.purchaseInTerminal();
}
```

---

## Part 3: Customer Purchase Flows

### Flow A: Browser Checkout

Best for first-time customers who need to enter payment details.

```typescript
// SDK handles everything:
// 1. Creates Stripe checkout session
// 2. Opens browser to payment page
// 3. Polls for completion
// 4. Saves license locally

await tuish.purchaseInBrowser({
  onSessionCreated: (url) => {
    console.log('Opening browser for payment...');
  },
  onComplete: (license) => {
    console.log('Purchase complete! License saved.');
  },
});
```

**What happens under the hood:**

```
SDK                           API                          Stripe
 │                             │                             │
 │  POST /v1/checkout/init     │                             │
 │  { productId, email }       │                             │
 │────────────────────────────▶│                             │
 │                             │  Create checkout session    │
 │                             │────────────────────────────▶│
 │                             │◀────────────────────────────│
 │  { sessionId, checkoutUrl } │                             │
 │◀────────────────────────────│                             │
 │                             │                             │
 │  [Open browser to URL]      │                             │
 │                             │                             │
 │  GET /v1/checkout/status    │                             │
 │  (polling every 2s)         │                             │
 │────────────────────────────▶│                             │
 │                             │                             │
 │  { status: 'complete',      │                             │
 │    license: {...} }         │                             │
 │◀────────────────────────────│                             │
 │                             │                             │
 │  [Save to ~/.tuish/]        │                             │
```

### Flow B: Terminal Purchase

Best for returning customers with saved payment methods.

```typescript
await tuish.purchaseInTerminal({
  onOtpSent: (phoneMasked) => {
    console.log(`OTP sent to ${phoneMasked}`);
  },
  onCardsLoaded: (cards) => {
    // Display card selection UI
    return selectCard(cards);
  },
  onComplete: (license) => {
    console.log('Purchase complete!');
  },
});
```

**What happens under the hood:**

```
SDK                           API                          Twilio
 │                             │                             │
 │  POST /v1/auth/login/init   │                             │
 │  { email }                  │                             │
 │────────────────────────────▶│  Send OTP via SMS           │
 │                             │────────────────────────────▶│
 │  { otpId, phoneMasked }     │                             │
 │◀────────────────────────────│                             │
 │                             │                             │
 │  [User enters OTP]          │                             │
 │                             │                             │
 │  POST /v1/auth/login/verify │                             │
 │  { email, otp, fingerprint }│                             │
 │────────────────────────────▶│                             │
 │  { identityToken, cards[] } │                             │
 │◀────────────────────────────│                             │
 │                             │                             │
 │  POST /v1/purchase/init     │                             │
 │  (Bearer: identityToken)    │                             │
 │────────────────────────────▶│                             │
 │  { cards[], amount }        │                             │
 │◀────────────────────────────│                             │
 │                             │                             │
 │  [User selects card]        │                             │
 │                             │                             │
 │  POST /v1/purchase/otp      │                             │
 │────────────────────────────▶│  Send confirmation OTP      │
 │  { otpId }                  │────────────────────────────▶│
 │◀────────────────────────────│                             │
 │                             │                             │
 │  [User enters OTP]          │                             │
 │                             │                             │
 │  POST /v1/purchase/confirm  │                             │
 │  { cardId, otp }            │                             │
 │────────────────────────────▶│  Charge card                │
 │                             │────────────────────────────▶│
 │  { success, license }       │                             │
 │◀────────────────────────────│                             │
```

---

## Part 4: License Verification

Once a customer has purchased, the SDK handles verification automatically:

```typescript
const result = await tuish.checkLicense();
```

**Verification strategy:**

1. **Check local cache** (`~/.tuish/licenses/`)
2. **Verify signature offline** (Ed25519)
3. **If cache > 24h old**, refresh online
4. **If network fails**, trust offline verification

```
┌──────────────────────────────────────────────────────┐
│                 checkLicense()                        │
├──────────────────────────────────────────────────────┤
│                                                      │
│  ┌─────────────┐                                     │
│  │ Load cache  │                                     │
│  └──────┬──────┘                                     │
│         │                                            │
│         ▼                                            │
│  ┌─────────────────┐     No      ┌───────────────┐  │
│  │ Cache exists?   │────────────▶│ Return invalid │  │
│  └────────┬────────┘             └───────────────┘  │
│           │ Yes                                      │
│           ▼                                          │
│  ┌─────────────────┐                                │
│  │ Verify offline  │ (Ed25519 signature check)      │
│  └────────┬────────┘                                │
│           │                                          │
│           ▼                                          │
│  ┌─────────────────┐     No      ┌───────────────┐  │
│  │ Signature valid?│────────────▶│ Return invalid │  │
│  └────────┬────────┘             └───────────────┘  │
│           │ Yes                                      │
│           ▼                                          │
│  ┌─────────────────┐     No      ┌───────────────┐  │
│  │ Cache < 24h?    │────────────▶│ Refresh online │  │
│  └────────┬────────┘             └───────┬───────┘  │
│           │ Yes                          │           │
│           ▼                              ▼           │
│  ┌─────────────────┐            ┌───────────────┐   │
│  │ Return valid    │            │ Network fail? │   │
│  └─────────────────┘            └───────┬───────┘   │
│                                         │           │
│                              Yes        │  No       │
│                         ┌───────────────┴───┐       │
│                         ▼                   ▼       │
│                  ┌───────────┐      ┌───────────┐   │
│                  │Trust cache│      │Use server │   │
│                  └───────────┘      │ response  │   │
│                                     └───────────┘   │
└──────────────────────────────────────────────────────┘
```

---

## API Endpoints Reference

All endpoints the SDK uses are implemented and deployed:

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/v1/checkout/init` | POST | Create Stripe checkout session |
| `/v1/checkout/status/:id` | GET | Poll for checkout completion |
| `/v1/auth/login/init` | POST | Request login OTP |
| `/v1/auth/login/verify` | POST | Verify OTP, get identity token |
| `/v1/purchase/init` | POST | Initialize terminal purchase |
| `/v1/purchase/otp` | POST | Request purchase confirmation OTP |
| `/v1/purchase/confirm` | POST | Confirm purchase with OTP |
| `/v1/licenses/validate` | POST | Online license validation |

See [API Reference](/docs/api) for full request/response details.

---

## Complete Example

```typescript
import { Tuish } from '@tuish/sdk';
import * as readline from 'readline';

const tuish = new Tuish({
  productId: process.env.TUISH_PRODUCT_ID!,
  publicKey: process.env.TUISH_PUBLIC_KEY!,
});

async function main() {
  console.log('Checking license...');

  const result = await tuish.checkLicense();

  if (result.valid) {
    console.log('✓ License valid');
    runApp();
    return;
  }

  console.log('No valid license. Purchase required.');

  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
  });

  const answer = await new Promise<string>((resolve) => {
    rl.question('Purchase now? [Y/n] ', resolve);
  });
  rl.close();

  if (answer.toLowerCase() !== 'n') {
    console.log('Opening browser for payment...');
    await tuish.purchaseInBrowser();
    console.log('✓ Purchase complete! License saved.');
    runApp();
  }
}

function runApp() {
  console.log('Running your awesome CLI...');
  // Your app code here
}

main().catch(console.error);
```

---

## Troubleshooting

### "Stripe account required" when creating products

Run `tuish connect` to link your Stripe account first.

### License not being saved

Check that `~/.tuish/licenses/` is writable.

### OTP not received

Ensure the customer has a verified phone number on file.

### Checkout session expired

Sessions expire after 24 hours. Create a new one with `purchaseInBrowser()`.
