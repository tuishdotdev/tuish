---
title: Terminal Purchase
description: Complete purchases without leaving the terminal
---

# Terminal Purchase

For returning customers, Tuish supports a full in-terminal purchase flow using saved cards and SMS OTP verification.

## Prerequisites

- Customer must have previously purchased (has saved cards)
- Customer must have a verified phone number

## Quick Flow

The `purchaseInTerminal` method handles the entire flow:

```typescript
const result = await tuish.purchaseInTerminal({
  email: 'user@example.com',

  // Called when login OTP is sent
  getLoginOtp: async (phoneMasked) => {
    return await prompt(`Enter code sent to ${phoneMasked}: `);
  },

  // Called to select payment card
  selectCard: async (cards, amount, currency) => {
    console.log(`Total: ${formatMoney(amount, currency)}`);
    for (const card of cards) {
      console.log(`${card.id}: ${card.brand} ****${card.last4}`);
    }
    return await prompt('Select card ID: ');
  },

  // Called when purchase OTP is sent
  getPurchaseOtp: async (phoneMasked) => {
    return await prompt(`Confirm purchase with code sent to ${phoneMasked}: `);
  },
});

if (result.success) {
  console.log('Purchase complete!');
  console.log('Receipt:', result.receiptUrl);
}
```

## Step-by-Step Flow

For more control, you can use the individual methods:

```typescript
// 1. Request login OTP
const loginOtp = await tuish.requestLoginOtp('user@example.com');
console.log(`Code sent to ${loginOtp.phoneMasked}`);

// 2. Verify login
const code = await getInput('Enter code: ');
const login = await tuish.verifyLogin({
  email: 'user@example.com',
  otpId: loginOtp.otpId,
  otp: code,
});

// 3. Initialize purchase (get saved cards)
const purchase = await tuish.initTerminalPurchase();
console.log(`${purchase.productName}: $${purchase.amount / 100}`);

// 4. User selects card
const cardId = selectCard(purchase.cards);

// 5. Request purchase confirmation OTP
const confirmOtp = await tuish.requestPurchaseOtp();

// 6. Confirm purchase
const purchaseCode = await getInput('Confirm purchase: ');
const result = await tuish.confirmTerminalPurchase({
  cardId,
  otpId: confirmOtp.otpId,
  otp: purchaseCode,
});

if (result.success) {
  console.log('Done!', result.receiptUrl);
}
```

## Types

```typescript
interface PurchaseInitResult {
  cards: SavedCard[];
  amount: number;      // In cents
  currency: string;
  phoneMasked: string;
  productName: string;
}

interface SavedCard {
  id: string;
  brand: string;       // visa, mastercard, etc.
  last4: string;
  expiryMonth: number;
  expiryYear: number;
}

interface PurchaseConfirmResult {
  success: boolean;
  license?: string;
  receiptUrl?: string;
  requiresAction?: boolean;  // 3DS required
  actionUrl?: string;
  error?: string;
}
```

## 3D Secure Handling

If `requiresAction` is true, you need to open the `actionUrl` in a browser for 3D Secure verification:

```typescript
if (result.requiresAction && result.actionUrl) {
  console.log('3D Secure verification required');
  await tuish.openUrl(result.actionUrl);
  // Wait for user to complete, then re-check license
}
```
